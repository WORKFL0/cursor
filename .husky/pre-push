#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Get the current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ“Š Current branch: $current_branch"

# Run comprehensive tests before pushing
echo "ğŸ§ª Running comprehensive test suite..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed. Push aborted."
  exit 1
fi

# Run security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level high --production
if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found. Please address them before pushing."
  echo "ğŸ’¡ You can run 'npm audit fix' to automatically fix some issues."
  exit 1
fi

# Check for secrets in code
echo "ğŸ” Scanning for secrets..."
if command -v git-secrets >/dev/null 2>&1; then
    git secrets --scan
    if [ $? -ne 0 ]; then
        echo "âŒ Potential secrets found in code. Push aborted."
        exit 1
    fi
else
    echo "âš ï¸  git-secrets not installed. Consider installing it for secret detection."
    # Basic check for common secret patterns
    if git diff --cached --name-only | xargs grep -l "AKIA\|sk-\|ghp_\|gho_\|ghu_\|ghs_\|password.*=.*['\"][^'\"]*['\"]" 2>/dev/null; then
        echo "âŒ Potential secrets detected. Please remove them before pushing."
        exit 1
    fi
fi

# Check build on staging/main branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "staging" ]; then
  echo "ğŸ—ï¸  Building production version for $current_branch branch..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Production build failed. Push to $current_branch aborted."
    exit 1
  fi
fi

# Check for TODOs in production branches
if [ "$current_branch" = "main" ]; then
  todo_count=$(git diff --cached --name-only | xargs grep -c "TODO\|FIXME\|XXX" 2>/dev/null | wc -l)
  if [ "$todo_count" -gt 0 ]; then
    echo "âš ï¸  Found TODO/FIXME comments in files being pushed to main branch:"
    git diff --cached --name-only | xargs grep -n "TODO\|FIXME\|XXX" 2>/dev/null || true
    echo "ğŸ’¡ Consider resolving these before pushing to production."
    echo "â“ Do you want to continue? (y/N)"
    read -r response
    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
      echo "Push aborted by user."
      exit 1
    fi
  fi
fi

# Check bundle size if analyzing
if [ -f "package.json" ] && grep -q "analyze" package.json; then
  echo "ğŸ“¦ Checking bundle size..."
  npm run analyze:size
fi

echo "âœ… All pre-push checks passed! ğŸ‰"